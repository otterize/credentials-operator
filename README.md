# Spifferize
Otterize-SPIFFE/SPIRE integration

## Installation instructions
### Prerequisites
```shell
brew install kustomize
```

### SPIRE Server & Agent Installation
1. Follow [SPIRE's Quickstart for Kubernetes](https://spiffe.io/docs/latest/try/getting-started-k8s/)

2. Add a SPIRE server entry for spifferize's operator (replace example.com with your trust domain)
```shell
kubectl exec -n spire spire-server-0 -- /opt/spire/bin/spire-server entry create \
    -spiffeID spiffe://example.org/ns/operator-system \
    -parentID spiffe://example.org/ns/spire/sa/spire-agent \
    -selector k8s:ns:operator-system -admin
```

### Spifferize Operator Installation
1. Build operator image & push to ECR
```shell
cd src
./operator/build_locally_and_push.sh
```

2. Deploy the operator to your kubernetes cluster 
```shell
cd src
./operator/deploy.sh
```

3. Undeploy operator
```shell
./operator/undeploy.sh
```


## Usage
1. Modify pod deployment:
```shell
apiVersion: apps/v1
kind: Deployment
spec:
  template:
    metadata:
      labels:
        # label with otterize service name; 
        # optional - will be auto-detected by operator if omitted
        otterize/service-name: myservice  
        # name of secret which will store TLS auth data, secret content auto-generated by operator; 
        # optional - if not set, no secret will be generated
        otterize/tls-secret-name: spifferize-tls-myservice 
      containers:
        - name: myservice
          ...
          volumeMounts:  # mount trust bundle & svid volumes to paths
            - name: spifferize-tls
              mountPath: /etc/spifferize
              readOnly: true
      volumes:  # mount trust bundle & svid secret to volume
        - name: spifferize-tls
          secret:
            secretName: spifferize-tls-myservice # should match the value of `otterize/tls-secret-name` label
```
2. Automatically registering SPIRE-server entries:
   1. Detecting service name:
      1. If the `otterize/service-name` label is set, the service name will be set to the same value.
      2. If `otterize/service-name` label does not exist, the operator automatically detects the service name 
         according to the pod owner (deployment) name. 
   2. The operator sets the `spifferize/selector-service-name` label, with the detected service name as value. 
      This label is set and maintained by the spifferize operator, do not set, modify or delete it manually. 
   3. The operator registers entries to SPIRE server, with the following details:
      1. SPIFFEID: `spiffe://<trustdomain>/namespace/<namespace>/service/<servicename>`
      2. Selectors: `k8s:ns:<namespace>` + `k8s:pod-label:spifferize/selector-service-name=<servicename>`
3. Automatically generating TLS secrets (trust bundles & x509-SVIDs):
   1. If the `otterize/tls-secret-name` label is set, the operator will automatically generate, refresh & manage
      TLS secrets (trust bundles & x509-SVIDs) for your pods, eliminate the need to communicate with the SPIRE agent.
   2. The secrets will be stored to your K8S cluster, under the name specified in `otterize/tls-secret-name`, in the
      same namespace as your pod.  
   3. To use a TLS secret, mount it through a volume mount with secret source, matching the same secret name (see example above).
   4. The secret contains `bundle.pem` (trust bundle), `key.pem` & `svid.pem` (SVID cert & private key), as encoded pem files.
   5. The TLS secrets will encode the same SPIFFEID derived from your namespace & service name, 
      i.e. `spiffe://<trustdomain>/namespace/<namespace>/service/<servicename>`

